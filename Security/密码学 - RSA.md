密码学 - RSA
---

### 0 概述

**隐蔽式安全是非常危险的!!!**
#### 0.1 几个概念

- 对称加密: 加密/解密用相同的密码
- 非对称加密: 加密/解密用不同的密码, 称为公钥和私钥, 公钥一般是公开的, 私钥不能公开

#### 0.2 密钥配送问题

我们比较常用且比较好理解的就是对称加密, 但是对称加密往往会遇到一个问题: 如何安全的配送密钥?
目前我们已知的方案:
- 事先共享(安全交付方式, 数量过大)
- 密钥分配中心(故障, 压力过大, 被攻击)
- Diffie-Hellman 密钥交换
- 非对称加密

#### 0.3 可以做什么

##### 0.3.1. 加密消息
后文会详述

##### 0.3.2. 签名消息
RSA也可以用来为一个消息署名. 假如 Alice 想给Bob传递一个署名的消息的话, 那么她可以为她的消息计算一个散列值（Message digest）, 然后用她的私钥加密这个散列值并将这个“署名”加在消息的后面. 这个消息只有用她的公钥才能被解密. Bob获得这个消息后可以用Alice的公钥解密这个散列值, 然后将这个数据与他自己为这个消息计算的散列值相比较. 假如两者相符的话, 那么他就可以知道发信人持有甲的密钥, 以及这个消息在传播路径上没有被篡改过.


### 1 预定义

- p, q: 两个不相等的大质数
- n: p, q 的乘积
- φ(n): n 的欧拉函数
- e: 1 < e < φ(n) 且 e, φ(n)互质(e 未必是质数)
- m: 明文
- c: 密文
- (n, e): 公钥
- (n, d): 私钥


### 2 敲黑板, 画重点

```sh
RSA 只能加密整数, 如果是字符串取 ascii 值或 unicode 值
RSA 的加解密过程, 可以说相当简单, 如果我们已经生成了 公钥/私钥 了, 那么
```

#### 2.1 加密:
```sh
c = m ^ e mod n
```

#### 2.2 解密:
```sh
m = c ^ d mod n
```

#### 2.3 例子:
```sh
公钥(n, e) => (323, 5)
私钥(n, d) => (323, 173)  # 隐私数据
明文 m => 123

加密:
c = 123 ^ 5 mod 323 = 225
得到密文 c: 225

解密:
m = 225 ^ 173 mod 323 = 123
得到明文 m: 123
```


### 3 生成密钥对

如果你不希望知道密钥对如何生成, 可以直接看下一小节
如果有兴趣, 那我们看看密钥对生成的方法

#### 3.1 预备知识 - 四个数学概念

##### 3.1.1 互质关系
概念: [互素][rsa-coprime-wiki]
简述: 最大公约数为 1; 即 gcd(a, b) = 1
表示: a ⊥ b

##### 3.1.2 欧拉函数
概念: [欧拉函数][rsa-euler-function]
简述: 小于或等于 n 的正整数中与 n 互质的数的数目
表示: φ(n)

##### 3.1.3 欧拉定理(费马小定理是欧拉定理的特例)
概念: [欧拉定理][rsa-euler-eulers therem]
简述: a, n 为正整数, 且互质, 则符合以下表达式
表示: a ^ φ(n) ≡ 1 (mod n)

##### 3.1.4 模反元素
概念: [模反元素][rsa-modular-inverses]
简述: a 为整数, 则符合以下表达式的 b 就是模反元素
表示: ab ≡ 1 (mod n)

#### 3.2 密钥对生成步骤

##### 3.2.1 密钥对生成步骤
```sh

大质数生成方式:
计算机生成伪随机数, 能通过费马测试/米勒.拉宾测试认为该数为质数

生成两个不相等的大质数: p, q
计算: n = pq
根据欧拉函数: φ(n) = φ(p)φ(q) = (p - 1)(q - 1)
根据 1 < e < φ(n) 且 e, φ(n) 互质: 生成 e  # 公钥生成 (n, e)
求得 e 的模反元素: ed ≡ 1 (mod φ(n))  # 私钥生成 (n, d)
销毁 p, q
```

##### 3.2.2 密钥对生成样例

```sh
p = 17, q = 19
n = pq = 17 * 19 = 323
φ(n) = φ(p)φ(q) = (17 - 1) * (19 - 1) = 288

e = 5  # 可以为 5, 7, 11, 13...
e * d mod φ(n) = 1 => 5d mod 288 = 1 => d = 173

e: 5
d: 173
n: 323
```

##### 3.2.3 下面这个式子怎么算?

```sh
8922765 ^ 923982 mod 163386443

可以用以下方式优化

((8922765 mod 163386443) * 8922765 mod 163386443)...
```

### 4 不足

1. 不能加密大于 n 的数据
2. 速度比较慢, 只有对称加密速度的几百分之一


### 5 攻击方式

#### 5.1 破译者可能知道的信息

- 密文: 可以窃听获取
- e/n: 公钥的公开信息

#### 5.2 破译者不知道对信息
- 明文: 需要破译的内容
- d: 私钥中的 d
- 其他: p, q, φ(n)

#### 5.3 攻击手段

##### 5.3.1 通过密文求得明文

通过以下算法获得 m, 如果没有 `mod n` 的话, 可以看作一个对数求解, 不是很难, 但如果加上来 `mod n` 之后, 变成了离散对数, 至今没有发现高效对离散对数算法
```sh
c = m ^ e mod n
```

#####  5.3.2 暴力破解找到 d

尝试所有可能的 d 的数字, n 的长度够大时候, 很难

#####  5.3.3  通过 e/n 求出 d

如果尝试通过以下方法 1 计算 d, 需要知道 `φ(n)`, 而想知道 `φ(n)`, 则必须知道方法 2 里的 `p`, `q`, 如果保护好 `p`, `q`, 破译者就不能破解密码
```sh
ed ≡ 1 (mod φ(n))  # 1
φ(n) = φ(p)φ(q) = (p - 1)(q - 1)  # 2
n = pq  # 3
```

#####  5.3.4 分解质因数 n

如前文所说, 没有找到有效的方式分解方法. 目前从原理上说, 如果[量子计算机][rsa-quantum-computer]有机会成为一种可行技术, RSA 会变得不可靠

#####  5.3.5 推测 p, q 进行攻击

如果伪随机数生成器策略不够好, 就有可能被推断出来, 有一些非常好的随机数算法, 已经被发表了, 因此不能被使用.
还需要注意的是: p/q 不能太靠近, p - 1/q - 1 的因子不能太小, 否则可以很快被分解; 有人证明: q < p < 2q 且 d < 1/3 * n ^ (1/4), 从 e, n 可以有效的推算 d
此外 e = 2 永远不应该被使用

##### 5.3.6 时间攻击
1995年有人提出了一种非常意想不到的攻击方式：假如Eve对Alice的硬件有充分的了解, 而且知道它对一些特定的消息加密时所需要的时间的话, 那么她可以很快地推导出d. 这种攻击方式之所以会成立, 主要是因为在进行加密时所进行的模指数运算是一个比特一个比特进行的, 而比特为1所花的运算比比特为0的运算要多很多, 因此若能得到多组消息与其加密时间, 就会有机会可以反推出私钥的内容

##### 5.3.7 中间人攻击
不能破译 RSA, 但是是针对机密性对有效性攻击, 仅靠公钥密码, 无法防御中间人攻击
现在一般靠可靠的第三方机构签发**证书**解决


### 6 其他

#### 6.1 质数会不会被用光么

> 512bit 能容纳对质数数量约为 10 ^ 150, 比宇宙中原子数量还要多
> 假设世界上有 100 亿人, 每人每秒生成 100 亿个密钥对, 那么经过 100 亿年之后, 会生成多少个密钥对呢?
```sh
1 年 = 366 * 24 * 60 * 60 = 31622400 秒
100 亿人 * 100 亿个 * 31622400 秒 * 100 亿年 < 10 * 39
```
#### 6.2 RSA 和大整数的质因数分解是否等价

快速完成质因数分解, 能破译 RSA
要破译 RSA, 是否必须进行质因数分解, 尚未得到证明

#### 6.3 多少长度的 N 才算安全

1997年后开发的系统, 用户应使用1024位密钥, 证书认证机构应用2048位或以上

#### 6.4 对称/非对称密钥长度

具备同等抵御暴力破解强度对密钥长度
摘自 -- <应用密码学>

| 对称密码 | 非对称密码 |
|:---------|:-----------|
| 128      | 2304       |
| 112      | 1792       |
| 80       | 768        |
| 64       | 512        |
| 56       | 384        |



[rsa-coprime-wiki]: https://zh.wikipedia.org/zh-cn/%E4%BA%92%E8%B3%AA
[rsa-euler-function]: https://zh.wikipedia.org/wiki/%E6%AC%A7%E6%8B%89%E5%87%BD%E6%95%B0
[rsa-euler-eulers therem]: https://zh.wikipedia.org/wiki/%E6%AC%A7%E6%8B%89%E5%AE%9A%E7%90%86_(%E6%95%B0%E8%AE%BA)
[rsa-modular-inverses]: https://zh.wikipedia.org/wiki/%E6%A8%A1%E5%8F%8D%E5%85%83%E7%B4%A0
[rsa-quantum-computer]: https://zh.wikipedia.org/wiki/%E9%87%8F%E5%AD%90%E8%AE%A1%E7%AE%97%E6%9C%BA
